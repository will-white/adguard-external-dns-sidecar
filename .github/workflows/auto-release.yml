name: Auto Release

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:
    inputs:
      latest:
        description: 'Tag as latest'
        required: false
        type: boolean
        default: true
      dry_run:
        description: 'Dry run (check for changes without tagging)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  # First, validate the code passes CI before considering a release
  validate:
    name: Validate Build
    uses: ./.github/workflows/build.yml
    with:
      push: false
    permissions:
      contents: read
      packages: read

  check-and-tag:
    name: Check for Changes
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          default_prerelease_bump: false
          dry_run: ${{ inputs.dry_run || false }}

      - name: Report changes detected
        if: steps.tag_version.outputs.new_tag != ''
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "**New Tag:** ${{ steps.tag_version.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tag:** ${{ steps.tag_version.outputs.previous_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tag_version.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY

      - name: No changes detected
        if: steps.tag_version.outputs.new_tag == ''
        run: |
          echo "## No Release Needed" >> $GITHUB_STEP_SUMMARY
          echo "No new commits since the last tag." >> $GITHUB_STEP_SUMMARY

  release:
    name: Build and Push Release
    needs: check-and-tag
    if: needs.check-and-tag.outputs.new_tag != '' && !inputs.dry_run
    uses: ./.github/workflows/build.yml
    with:
      push: true
      version: ${{ needs.check-and-tag.outputs.new_tag }}
      latest: ${{ github.event_name == 'schedule' || inputs.latest }}
    permissions:
      contents: read
      packages: write
